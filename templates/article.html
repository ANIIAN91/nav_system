<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章 - 个人主页</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <a href="/" class="btn btn-secondary">返回</a>
            <div style="display: flex; align-items: center; gap: 12px;">
                <h1 class="page-title" id="page-title">文章</h1>
                <button id="theme-toggle" class="btn btn-secondary" title="切换主题">&#9790;</button>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="main-content article-page">
            <!-- 文章列表 -->
            <aside id="article-list" class="article-sidebar">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0;">文章目录</h3>
                    <button id="manage-folders-btn" class="btn btn-secondary" style="display: none; padding: 5px 10px; font-size: 12px;">管理</button>
                </div>
                <div id="articles-tree"></div>
            </aside>

            <!-- 文章内容 -->
            <article id="article-content" class="article-content">
                <div id="article-toolbar" style="display: none; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                    <button id="edit-article-btn" class="btn btn-secondary" style="margin-right: 10px;">编辑</button>
                    <button id="delete-article-btn" class="btn btn-danger">删除</button>
                </div>
                <div id="article-body">
                    <p class="placeholder">请从左侧选择文章</p>
                </div>
            </article>
        </main>

        <!-- 编辑文章弹窗 -->
        <div id="edit-article-modal" class="modal">
            <div class="modal-content" style="max-width: 900px; width: 90%;">
                <span class="close">&times;</span>
                <h2>编辑文章</h2>
                <form id="edit-article-form">
                    <input type="hidden" id="edit-article-path">
                    <div class="form-group">
                        <label for="edit-article-content">内容 (Markdown)</label>
                        <textarea id="edit-article-content" name="content" rows="20" style="width: 100%; font-family: monospace; resize: vertical;"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">保存</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('edit-article-modal')">取消</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 目录管理弹窗 -->
        <div id="folder-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>目录管理</h2>
                <div class="form-group">
                    <label>新建目录</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-folder-name" placeholder="目录名称" style="flex: 1;">
                        <button type="button" id="create-folder-btn" class="btn btn-primary">创建</button>
                    </div>
                </div>
                <hr style="margin: 20px 0; border-color: var(--border-color);">
                <div class="form-group">
                    <label>现有目录</label>
                    <div id="folder-list" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- 编辑目录弹窗 -->
        <div id="edit-folder-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>编辑目录</h2>
                <form id="edit-folder-form">
                    <input type="hidden" id="edit-folder-old-name">
                    <div class="form-group">
                        <label for="edit-folder-name">目录名称</label>
                        <input type="text" id="edit-folder-name" name="name" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">保存</button>
                        <button type="button" id="delete-folder-btn" class="btn btn-danger">删除目录</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 底部 -->
        <footer class="footer">
            <div id="footer-content">
                <span id="icp-info"></span>
            </div>
        </footer>
    </div>

    <!-- 回到顶部按钮 -->
    <button id="back-to-top" class="back-to-top" title="回到顶部">&#9650;</button>

    {% if settings and settings.analytics_code %}
    <!-- 统计分析代码 -->
    {{ settings.analytics_code | safe }}
    {% endif %}

    <script>
        // 检查登录状态（token 可能在 localStorage 或 sessionStorage 中）
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        let currentArticlePath = null;
        let currentArticleContent = null;

        // API 请求封装
        async function api(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            return fetch(url, { ...options, headers });
        }

        // 弹窗控制
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // 主题切换
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const btn = document.getElementById('theme-toggle');
            if (btn) {
                btn.innerHTML = theme === 'light' ? '&#9728;' : '&#9790;';
            }
        }

        // 更新UI（根据登录状态显示管理按钮）
        function updateUI() {
            if (token) {
                document.getElementById('manage-folders-btn').style.display = 'block';
            }
        }

        // 加载站点设置
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                // 更新页面标题
                const titleEl = document.getElementById('page-title');
                if (titleEl && settings.article_page_title) {
                    titleEl.textContent = settings.article_page_title;
                    document.title = settings.article_page_title + ' - 个人主页';
                }

                // 更新备案信息显示
                const icpEl = document.getElementById('icp-info');
                if (icpEl) {
                    let footerText = '';
                    if (settings.copyright) footerText += settings.copyright;
                    if (settings.icp) footerText += (footerText ? ' | ' : '') + settings.icp;
                    icpEl.textContent = footerText || '';
                }

                return settings;
            } catch (error) {
                console.error('加载设置失败:', error);
                return {};
            }
        }

        // 获取文章列表
        async function loadArticles() {
            try {
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                const response = await fetch('/api/articles', { headers });
                const data = await response.json();
                renderArticleTree(data.articles);
            } catch (error) {
                console.error('加载文章列表失败:', error);
            }
        }

        // HTML 转义
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 渲染文章树（带折叠功能）
        function renderArticleTree(articles) {
            const tree = document.getElementById('articles-tree');
            const categories = {};

            // 按分类分组
            articles.forEach(article => {
                const cat = article.category || '未分类';
                if (!categories[cat]) {
                    categories[cat] = [];
                }
                categories[cat].push(article);
            });

            // 获取保存的折叠状态
            const collapsedState = JSON.parse(localStorage.getItem('articleCollapsed') || '{}');

            // 渲染
            let html = '';
            for (const [category, items] of Object.entries(categories)) {
                const isCollapsed = collapsedState[category] === true;
                html += `<div class="article-category ${isCollapsed ? 'collapsed' : ''}" data-category="${escapeHtml(category)}">
                    <div class="article-category-header">
                        <h4><span class="collapse-icon">&#9660;</span> ${escapeHtml(category)}</h4>
                    </div>
                    <ul>`;
                items.forEach(item => {
                    html += `<li><a href="#" data-path="${escapeHtml(item.path)}">${escapeHtml(item.title)}</a></li>`;
                });
                html += `</ul></div>`;
            }

            if (html === '') {
                html = '<p class="no-articles">暂无文章</p>';
            }

            tree.innerHTML = html;

            // 绑定折叠事件
            tree.querySelectorAll('.article-category-header').forEach(header => {
                header.addEventListener('click', () => {
                    const category = header.closest('.article-category');
                    category.classList.toggle('collapsed');

                    // 保存折叠状态
                    const categoryName = category.dataset.category;
                    const collapsedState = JSON.parse(localStorage.getItem('articleCollapsed') || '{}');
                    collapsedState[categoryName] = category.classList.contains('collapsed');
                    localStorage.setItem('articleCollapsed', JSON.stringify(collapsedState));
                });
            });

            // 绑定点击事件
            tree.querySelectorAll('a[data-path]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadArticle(link.dataset.path);
                    // 更新选中状态
                    tree.querySelectorAll('a').forEach(a => a.classList.remove('active'));
                    link.classList.add('active');
                });
            });
        }

        // 加载文章内容
        async function loadArticle(path) {
            try {
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                const response = await fetch(`/api/articles/${path}`, { headers });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || '文章不存在');
                }
                const data = await response.json();
                document.getElementById('article-body').innerHTML = data.html;

                // 保存当前文章信息
                currentArticlePath = path;
                currentArticleContent = data.content;

                // 如果已登录，显示工具栏
                if (token) {
                    document.getElementById('article-toolbar').style.display = 'block';
                }
            } catch (error) {
                document.getElementById('article-body').innerHTML = `<p class="error">加载失败: ${error.message}</p>`;
                currentArticlePath = null;
                currentArticleContent = null;
                document.getElementById('article-toolbar').style.display = 'none';
            }
        }

        // 编辑文章
        function openEditArticleModal() {
            if (!currentArticlePath || !currentArticleContent) {
                alert('请先选择一篇文章');
                return;
            }
            document.getElementById('edit-article-path').value = currentArticlePath;
            document.getElementById('edit-article-content').value = currentArticleContent;
            openModal('edit-article-modal');
        }

        // 保存文章
        async function saveArticle(path, content) {
            try {
                const response = await api(`/api/articles/${path}`, {
                    method: 'PUT',
                    body: JSON.stringify({ content })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || '保存失败');
                }
                closeModal('edit-article-modal');
                loadArticle(path);
                alert('文章已保存');
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }

        // 删除文章
        async function deleteArticle() {
            if (!currentArticlePath) {
                alert('请先选择一篇文章');
                return;
            }
            if (!confirm('确定要删除这篇文章吗？此操作不可恢复。')) return;

            try {
                const response = await api(`/api/articles/${currentArticlePath}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || '删除失败');
                }
                currentArticlePath = null;
                currentArticleContent = null;
                document.getElementById('article-body').innerHTML = '<p class="placeholder">文章已删除</p>';
                document.getElementById('article-toolbar').style.display = 'none';
                loadArticles();
                alert('文章已删除');
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 加载目录列表
        async function loadFolders() {
            try {
                const response = await api('/api/folders');
                if (!response.ok) throw new Error('加载失败');
                const data = await response.json();
                renderFolders(data.folders);
            } catch (error) {
                document.getElementById('folder-list').innerHTML = '<p style="color: var(--danger-color);">加载失败</p>';
            }
        }

        // 渲染目录列表
        function renderFolders(folders) {
            const container = document.getElementById('folder-list');
            if (!folders || folders.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">暂无目录</p>';
                return;
            }

            let html = '';
            folders.forEach(folder => {
                html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                    <span>${escapeHtml(folder.name)} <small style="color: var(--text-muted);">(${folder.article_count} 篇)</small></span>
                    <button class="btn btn-secondary edit-folder-btn" data-name="${escapeHtml(folder.name)}" style="padding: 5px 10px; font-size: 12px;">编辑</button>
                </div>`;
            });
            container.innerHTML = html;

            // 绑定编辑按钮事件
            container.querySelectorAll('.edit-folder-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    openEditFolderModal(btn.dataset.name);
                });
            });
        }

        // 创建目录
        async function createFolder(name) {
            try {
                const response = await api(`/api/folders?name=${encodeURIComponent(name)}`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || '创建失败');
                }
                document.getElementById('new-folder-name').value = '';
                loadFolders();
                loadArticles();
                alert('目录创建成功');
            } catch (error) {
                alert('创建失败: ' + error.message);
            }
        }

        // 打开编辑目录弹窗
        function openEditFolderModal(name) {
            document.getElementById('edit-folder-old-name').value = name;
            document.getElementById('edit-folder-name').value = name;
            openModal('edit-folder-modal');
        }

        // 重命名目录
        async function renameFolder(oldName, newName) {
            try {
                const response = await api(`/api/folders/${encodeURIComponent(oldName)}`, {
                    method: 'PUT',
                    body: JSON.stringify({ new_name: newName })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || '重命名失败');
                }
                closeModal('edit-folder-modal');
                loadFolders();
                loadArticles();
                alert('目录重命名成功');
            } catch (error) {
                alert('重命名失败: ' + error.message);
            }
        }

        // 删除目录
        async function deleteFolder(name) {
            if (!confirm(`确定要删除目录 "${name}" 及其中的所有文章吗？此操作不可恢复。`)) return;

            try {
                const response = await api(`/api/folders/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || '删除失败');
                }
                closeModal('edit-folder-modal');
                loadFolders();
                loadArticles();
                alert('目录已删除');
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 检查 URL 中是否有文章路径
        function checkUrlPath() {
            const path = window.location.pathname.replace('/articles/', '').replace('/articles', '');
            if (path && path !== '/') {
                loadArticle(path);
            }
        }

        // 回到顶部按钮逻辑
        function initBackToTop() {
            const backToTopBtn = document.getElementById('back-to-top');
            if (!backToTopBtn) return;

            // 监听滚动事件，控制按钮显示/隐藏
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
            });

            // 点击按钮滚动到顶部
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            updateUI();
            loadSettings();
            loadArticles();
            checkUrlPath();
            initBackToTop();

            document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);

            // 编辑文章按钮
            document.getElementById('edit-article-btn')?.addEventListener('click', openEditArticleModal);

            // 删除文章按钮
            document.getElementById('delete-article-btn')?.addEventListener('click', deleteArticle);

            // 编辑文章表单
            document.getElementById('edit-article-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const path = document.getElementById('edit-article-path').value;
                const content = document.getElementById('edit-article-content').value;
                saveArticle(path, content);
            });

            // 目录管理按钮
            document.getElementById('manage-folders-btn')?.addEventListener('click', () => {
                loadFolders();
                openModal('folder-modal');
            });

            // 创建目录按钮
            document.getElementById('create-folder-btn')?.addEventListener('click', () => {
                const name = document.getElementById('new-folder-name').value.trim();
                if (!name) {
                    alert('请输入目录名称');
                    return;
                }
                createFolder(name);
            });

            // 编辑目录表单
            document.getElementById('edit-folder-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const oldName = document.getElementById('edit-folder-old-name').value;
                const newName = document.getElementById('edit-folder-name').value.trim();
                if (!newName) {
                    alert('请输入目录名称');
                    return;
                }
                renameFolder(oldName, newName);
            });

            // 删除目录按钮
            document.getElementById('delete-folder-btn')?.addEventListener('click', () => {
                const name = document.getElementById('edit-folder-old-name').value;
                deleteFolder(name);
            });

            // 关闭弹窗
            document.querySelectorAll('.modal .close').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal').classList.remove('active');
                });
            });

            // 点击弹窗外部关闭
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        });
    </script>
</body>
</html>
